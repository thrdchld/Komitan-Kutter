name: Build Flutter APK (Final Fix)

on:
  push:
    paths:
      - '.github/workflows/flutter-build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      # Lokasi SDK Kustom di dalam workspace
      MY_SDK: ${{ github.workspace }}/custom-android-sdk

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'

      # 1. Install SDK 35 di Folder Kustom
      - name: Setup Custom SDK 35
        run: |
          mkdir -p $MY_SDK/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmd.zip
          unzip -q cmd.zip -d $MY_SDK/cmdline-tools
          mv $MY_SDK/cmdline-tools/cmdline-tools $MY_SDK/cmdline-tools/latest
          
          export PATH=$MY_SDK/cmdline-tools/latest/bin:$PATH
          yes | sdkmanager --licenses --sdk_root=$MY_SDK > /dev/null
          # Install SDK 35 dan Build Tools 35.0.0
          yes | sdkmanager "platforms;android-35" "build-tools;35.0.0" "platform-tools" --sdk_root=$MY_SDK

      # 2. Create Android Project & Configure
      - name: Create Android Project & Configure
        run: |
          echo "Current directory: $(pwd)"
          ls -la
          flutter create . --platforms=android --project-name komitan_kutter
          echo "After flutter create:"
          ls -la
          ls -la android/

          # PAKSA Gradle melihat ke SDK Custom lewat local.properties
          echo "sdk.dir=$MY_SDK" > android/local.properties

          # Update Kotlin version
          sed -i "s/ext.kotlin_version = '1.9.22'/ext.kotlin_version = '1.9.24'/" android/build.gradle

          # Update AGP version
          sed -i "s/classpath 'com.android.tools.build:gradle:8.3.0'/classpath 'com.android.tools.build:gradle:8.7.0'/" android/build.gradle

          # Update compileSdkVersion
          sed -i 's/compileSdkVersion flutter.compileSdkVersion/compileSdkVersion 35/' android/app/build.gradle
          sed -i 's/compileSdkVersion 34/compileSdkVersion 35/' android/app/build.gradle

          # Update targetSdkVersion
          sed -i 's/targetSdkVersion flutter.targetSdkVersion/targetSdkVersion 35/' android/app/build.gradle
          sed -i 's/targetSdkVersion 34/targetSdkVersion 35/' android/app/build.gradle

          # Update buildToolsVersion
          sed -i 's/buildToolsVersion flutter.buildToolsVersion/buildToolsVersion "35.0.0"/' android/app/build.gradle

          # Update minSdkVersion
          sed -i 's/minSdkVersion flutter.minSdkVersion/minSdkVersion 30/' android/app/build.gradle
          sed -i 's/minSdkVersion 21/minSdkVersion 30/' android/app/build.gradle

          # Add namespace
          sed -i '/android {/a \    namespace "com.komitan.komitan_kutter"' android/app/build.gradle

          # Add multiDexEnabled
          sed -i '/versionName flutter.versionName/a \        multiDexEnabled true' android/app/build.gradle

          # Update Gradle wrapper
          echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.13-bin.zip" > android/gradle/wrapper/gradle-wrapper.properties
          wget -q https://github.com/gradle/gradle/raw/v8.13.0/gradle/wrapper/gradle-wrapper.jar -O android/gradle/wrapper/gradle-wrapper.jar

      # 4. Inject Permissions
      - name: Inject Permissions
        run: |
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>' android/app/src/main/AndroidManifest.xml
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>' android/app/src/main/AndroidManifest.xml
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"/>' android/app/src/main/AndroidManifest.xml

      # 5. Build
      - name: Build APK
        run: |
          flutter pub get
          flutter build apk --release --split-per-abi --verbose

      # 6. Upload
      - uses: actions/upload-artifact@v4
        with:
          name: KomitanKutter-Final-APK
          path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
