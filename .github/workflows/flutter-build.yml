name: Build Flutter APK (Private SDK 35)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      JAVA_VERSION: '17'
      FLUTTER_VERSION: '3.19.0'
      # Lokasi SDK Kustom (Agar bersih)
      MY_SDK_ROOT: ${{ github.workspace }}/android-sdk-custom

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      # 1. Setup Private Android SDK 35
      - name: Setup Clean Android SDK 35
        run: |
          echo "ðŸ› ï¸ Preparing Private Android SDK 35..."
          mkdir -p $MY_SDK_ROOT/cmdline-tools
          
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline.zip
          unzip -q cmdline.zip -d $MY_SDK_ROOT/cmdline-tools
          mv $MY_SDK_ROOT/cmdline-tools/cmdline-tools $MY_SDK_ROOT/cmdline-tools/latest
          
          # Export ENV untuk step ini & selanjutnya
          echo "ANDROID_HOME=$MY_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$MY_SDK_ROOT" >> $GITHUB_ENV
          echo "$MY_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$MY_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          
          # Install
          export PATH=$MY_SDK_ROOT/cmdline-tools/latest/bin:$PATH
          yes | sdkmanager --licenses > /dev/null
          
          # Install paket wajib untuk ffmpeg_kit_new (SDK 35 & Build Tools 34/35)
          yes | sdkmanager "platforms;android-35" "build-tools;35.0.0" "platform-tools"

      # 2. Generate Project
      - name: Create Android Platform
        run: flutter create . --platforms=android

      # 3. Konfigurasi Gradle untuk SDK 35 (Hard Overwrite)
      - name: Configure Gradle for SDK 35
        run: |
          # Root build.gradle (Kotlin 1.9.20 + AGP 8.2.0)
          cat > android/build.gradle <<GRADLE
          buildscript {
              ext.kotlin_version = '1.9.20'
              repositories { google(); mavenCentral() }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.2.0'
                  classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:\$kotlin_version"
              }
          }
          allprojects { repositories { google(); mavenCentral(); maven { url 'https://jitpack.io' } } }
          rootProject.buildDir = '../build'
          subprojects { project.buildDir = "\${rootProject.buildDir}/\${project.name}" }
          subprojects { project.evaluationDependsOn(':app') }
          task clean(type: Delete) { delete rootProject.buildDir }
GRADLE

          # App build.gradle (MinSDK 24, Target 35)
          cat > android/app/build.gradle <<APPGRADLE
          def localProperties = new Properties()
          def localPropertiesFile = rootProject.file('local.properties')
          if (localPropertiesFile.exists()) {
              localPropertiesFile.withReader('UTF-8') { reader -> localProperties.load(reader) }
          }
          def flutterRoot = localProperties.getProperty('flutter.sdk')
          if (flutterRoot == null) throw new GradleException("Flutter SDK not found.")
          
          def flutterVersionCode = localProperties.getProperty('flutter.versionCode')
          if (flutterVersionCode == null) flutterVersionCode = '1'
          def flutterVersionName = localProperties.getProperty('flutter.versionName')
          if (flutterVersionName == null) flutterVersionName = '1.0'

          apply plugin: 'com.android.application'
          apply plugin: 'kotlin-android'
          apply from: "\$flutterRoot/packages/flutter_tools/gradle/flutter.gradle"

          android {
              namespace "com.komitan.komitan_kutter"
              compileSdkVersion 35
              buildToolsVersion "35.0.0"
              
              compileOptions { sourceCompatibility JavaVersion.VERSION_1_8; targetCompatibility JavaVersion.VERSION_1_8 }
              kotlinOptions { jvmTarget = '1.8' }
              sourceSets { main.java.srcDirs += 'src/main/kotlin' }
              
              defaultConfig {
                  applicationId "com.komitan.komitan_kutter"
                  minSdkVersion 24
                  targetSdkVersion 35
                  versionCode flutterVersionCode.toInteger()
                  versionName flutterVersionName
                  multiDexEnabled true
              }
              buildTypes { release { signingConfig signingConfigs.debug } }
          }
          flutter { source '../..' }
          dependencies {
              implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:\$kotlin_version"
              implementation "androidx.multidex:multidex:2.0.1"
          }
APPGRADLE

          # Update Wrapper ke 8.5
          mkdir -p android/gradle/wrapper
          echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-all.zip" > android/gradle/wrapper/gradle-wrapper.properties

      # 4. Inject Izin ke Manifest
      - name: Inject Permissions
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          cat > $MANIFEST <<EOF
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.komitan.komitan_kutter">
              <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
              <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
              <uses-permission android:name="android.permission.INTERNET"/>
              <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"/>
              <application
                  android:label="Komitan Kutter"
                  android:name="\${applicationName}"
                  android:icon="@mipmap/ic_launcher">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop"
                      android:theme="@style/LaunchTheme"
                      android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
                      android:hardwareAccelerated="true"
                      android:windowSoftInputMode="adjustResize">
                      <meta-data android:name="io.flutter.embedding.android.NormalTheme" android:resource="@style/NormalTheme"/>
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
                  <meta-data android:name="flutterEmbedding" android:value="2" />
              </application>
          </manifest>
EOF

      # 5. Build
      - name: Build APK
        run: |
          flutter pub get
          flutter build apk --release --split-per-abi --verbose

      # 6. Upload
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: KomitanKutter-Final
          path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
